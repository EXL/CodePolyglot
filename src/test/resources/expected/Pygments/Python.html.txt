<table class="code-table"><tr id="line-1"><td class="table-line l-table"><a href="#line-1">1</a></td><td class="code-line l-code"><span class="ch">#!/usr/bin/env python3</span>
</td></tr><tr id="line-2"><td class="table-line d-table"><a href="#line-2">2</a></td><td class="code-line d-code"><span class="c1"># -*- coding: utf-8 -*-</span>
</td></tr><tr id="line-3"><td class="table-line l-table"><a href="#line-3">3</a></td><td class="code-line l-code">
</td></tr><tr id="line-4"><td class="table-line d-table"><a href="#line-4">4</a></td><td class="code-line d-code"><span class="c1">#  The MIT License (MIT)</span>
</td></tr><tr id="line-5"><td class="table-line l-table"><a href="#line-5">5</a></td><td class="code-line l-code"><span class="c1">#</span>
</td></tr><tr id="line-6"><td class="table-line d-table"><a href="#line-6">6</a></td><td class="code-line d-code"><span class="c1">#  Copyright (c) 2015-2020 EXL &lt;exlmotodev@gmail.com&gt;</span>
</td></tr><tr id="line-7"><td class="table-line l-table"><a href="#line-7">7</a></td><td class="code-line l-code"><span class="c1">#</span>
</td></tr><tr id="line-8"><td class="table-line d-table"><a href="#line-8">8</a></td><td class="code-line d-code"><span class="c1">#  Permission is hereby granted, free of charge, to any person obtaining a copy</span>
</td></tr><tr id="line-9"><td class="table-line l-table"><a href="#line-9">9</a></td><td class="code-line l-code"><span class="c1">#  of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
</td></tr><tr id="line-10"><td class="table-line d-table"><a href="#line-10"><strong>10</strong></a></td><td class="code-line d-code"><span class="c1">#  in the Software without restriction, including without limitation the rights</span>
</td></tr><tr id="line-11"><td class="table-line l-table"><a href="#line-11">11</a></td><td class="code-line l-code"><span class="c1">#  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
</td></tr><tr id="line-12"><td class="table-line d-table"><a href="#line-12">12</a></td><td class="code-line d-code"><span class="c1">#  copies of the Software, and to permit persons to whom the Software is</span>
</td></tr><tr id="line-13"><td class="table-line l-table"><a href="#line-13">13</a></td><td class="code-line l-code"><span class="c1">#  furnished to do so, subject to the following conditions:</span>
</td></tr><tr id="line-14"><td class="table-line d-table"><a href="#line-14">14</a></td><td class="code-line d-code"><span class="c1">#</span>
</td></tr><tr id="line-15"><td class="table-line l-table"><a href="#line-15">15</a></td><td class="code-line l-code"><span class="c1">#  The above copyright notice and this permission notice shall be included in all</span>
</td></tr><tr id="line-16"><td class="table-line d-table"><a href="#line-16">16</a></td><td class="code-line d-code"><span class="c1">#  copies or substantial portions of the Software.</span>
</td></tr><tr id="line-17"><td class="table-line l-table"><a href="#line-17">17</a></td><td class="code-line l-code"><span class="c1">#</span>
</td></tr><tr id="line-18"><td class="table-line d-table"><a href="#line-18">18</a></td><td class="code-line d-code"><span class="c1">#  THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
</td></tr><tr id="line-19"><td class="table-line l-table"><a href="#line-19">19</a></td><td class="code-line l-code"><span class="c1">#  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
</td></tr><tr id="line-20"><td class="table-line d-table"><a href="#line-20"><strong>20</strong></a></td><td class="code-line d-code"><span class="c1">#  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
</td></tr><tr id="line-21"><td class="table-line l-table"><a href="#line-21">21</a></td><td class="code-line l-code"><span class="c1">#  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
</td></tr><tr id="line-22"><td class="table-line d-table"><a href="#line-22">22</a></td><td class="code-line d-code"><span class="c1">#  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
</td></tr><tr id="line-23"><td class="table-line l-table"><a href="#line-23">23</a></td><td class="code-line l-code"><span class="c1">#  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
</td></tr><tr id="line-24"><td class="table-line d-table"><a href="#line-24">24</a></td><td class="code-line d-code"><span class="c1">#  SOFTWARE.</span>
</td></tr><tr id="line-25"><td class="table-line l-table"><a href="#line-25">25</a></td><td class="code-line l-code">
</td></tr><tr id="line-26"><td class="table-line d-table"><a href="#line-26">26</a></td><td class="code-line d-code"><span class="sd">&quot;&quot;&quot;</span>
</td></tr><tr id="line-27"><td class="table-line l-table"><a href="#line-27">27</a></td><td class="code-line l-code"><span class="sd">Install necessary PIP packages:</span>
</td></tr><tr id="line-28"><td class="table-line d-table"><a href="#line-28">28</a></td><td class="code-line d-code"><span class="sd">	$ pip3 install psycopg2</span>
</td></tr><tr id="line-29"><td class="table-line l-table"><a href="#line-29">29</a></td><td class="code-line l-code"><span class="sd">	$ pip3 install telethon</span>
</td></tr><tr id="line-30"><td class="table-line d-table"><a href="#line-30"><strong>30</strong></a></td><td class="code-line d-code"><span class="sd">	$ pip3 install mysql-connector-python</span>
</td></tr><tr id="line-31"><td class="table-line l-table"><a href="#line-31">31</a></td><td class="code-line l-code">
</td></tr><tr id="line-32"><td class="table-line d-table"><a href="#line-32">32</a></td><td class="code-line d-code"><span class="sd">Run as:</span>
</td></tr><tr id="line-33"><td class="table-line l-table"><a href="#line-33">33</a></td><td class="code-line l-code"><span class="sd">	$ cd db_import/</span>
</td></tr><tr id="line-34"><td class="table-line d-table"><a href="#line-34">34</a></td><td class="code-line d-code"><span class="sd">	$ TG_API_ID=&lt;id&gt; TG_API_HASH=&lt;hash&gt; MF_CHAT_ID=&lt;id&gt; \</span>
</td></tr><tr id="line-35"><td class="table-line l-table"><a href="#line-35">35</a></td><td class="code-line l-code"><span class="sd">	DB_USER_1=&lt;user&gt; DB_PASS_1=&lt;password&gt; DB_NAME_1=&lt;database&gt; DB_HOST_1=&lt;host&gt; \</span>
</td></tr><tr id="line-36"><td class="table-line d-table"><a href="#line-36">36</a></td><td class="code-line d-code"><span class="sd">	DB_USER_2=&lt;user&gt; DB_PASS_2=&lt;password&gt; DB_NAME_2=&lt;database&gt; DB_HOST_2=&lt;host&gt; \</span>
</td></tr><tr id="line-37"><td class="table-line l-table"><a href="#line-37">37</a></td><td class="code-line l-code"><span class="sd">	./db_import.py</span>
</td></tr><tr id="line-38"><td class="table-line d-table"><a href="#line-38">38</a></td><td class="code-line d-code">
</td></tr><tr id="line-39"><td class="table-line l-table"><a href="#line-39">39</a></td><td class="code-line l-code"><span class="sd">Do not forget to create tables before running the import script. After execution, user avatars should be updated.</span>
</td></tr><tr id="line-40"><td class="table-line d-table"><a href="#line-40"><strong>40</strong></a></td><td class="code-line d-code"><span class="sd">&quot;&quot;&quot;</span>
</td></tr><tr id="line-41"><td class="table-line l-table"><a href="#line-41">41</a></td><td class="code-line l-code">
</td></tr><tr id="line-42"><td class="table-line d-table"><a href="#line-42">42</a></td><td class="code-line d-code"><span class="kn">import</span> <span class="nn">os</span>
</td></tr><tr id="line-43"><td class="table-line l-table"><a href="#line-43">43</a></td><td class="code-line l-code"><span class="kn">import</span> <span class="nn">time</span>
</td></tr><tr id="line-44"><td class="table-line d-table"><a href="#line-44">44</a></td><td class="code-line d-code">
</td></tr><tr id="line-45"><td class="table-line l-table"><a href="#line-45">45</a></td><td class="code-line l-code"><span class="kn">import</span> <span class="nn">mysql.connector</span>
</td></tr><tr id="line-46"><td class="table-line d-table"><a href="#line-46">46</a></td><td class="code-line d-code"><span class="kn">import</span> <span class="nn">psycopg2</span>
</td></tr><tr id="line-47"><td class="table-line l-table"><a href="#line-47">47</a></td><td class="code-line l-code"><span class="kn">import</span> <span class="nn">telethon.sync</span>
</td></tr><tr id="line-48"><td class="table-line d-table"><a href="#line-48">48</a></td><td class="code-line d-code">
</td></tr><tr id="line-49"><td class="table-line l-table"><a href="#line-49">49</a></td><td class="code-line l-code">
</td></tr><tr id="line-50"><td class="table-line d-table"><a href="#line-50"><strong>50</strong></a></td><td class="code-line d-code"><span class="k">class</span> <span class="nc">Logger</span><span class="p">:</span>
</td></tr><tr id="line-51"><td class="table-line l-table"><a href="#line-51">51</a></td><td class="code-line l-code">	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</td></tr><tr id="line-52"><td class="table-line d-table"><a href="#line-52">52</a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;import.log&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
</td></tr><tr id="line-53"><td class="table-line l-table"><a href="#line-53">53</a></td><td class="code-line l-code">
</td></tr><tr id="line-54"><td class="table-line d-table"><a href="#line-54">54</a></td><td class="code-line d-code">	<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
</td></tr><tr id="line-55"><td class="table-line l-table"><a href="#line-55">55</a></td><td class="code-line l-code">		<span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</td></tr><tr id="line-56"><td class="table-line d-table"><a href="#line-56">56</a></td><td class="code-line d-code">		<span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
</td></tr><tr id="line-57"><td class="table-line l-table"><a href="#line-57">57</a></td><td class="code-line l-code">
</td></tr><tr id="line-58"><td class="table-line d-table"><a href="#line-58">58</a></td><td class="code-line d-code">	<span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
</td></tr><tr id="line-59"><td class="table-line l-table"><a href="#line-59">59</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</td></tr><tr id="line-60"><td class="table-line d-table"><a href="#line-60"><strong>60</strong></a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</td></tr><tr id="line-61"><td class="table-line l-table"><a href="#line-61">61</a></td><td class="code-line l-code">		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</td></tr><tr id="line-62"><td class="table-line d-table"><a href="#line-62">62</a></td><td class="code-line d-code">
</td></tr><tr id="line-63"><td class="table-line l-table"><a href="#line-63">63</a></td><td class="code-line l-code">	<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</td></tr><tr id="line-64"><td class="table-line d-table"><a href="#line-64">64</a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exiting...&#39;</span><span class="p">)</span>
</td></tr><tr id="line-65"><td class="table-line l-table"><a href="#line-65">65</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</td></tr><tr id="line-66"><td class="table-line d-table"><a href="#line-66">66</a></td><td class="code-line d-code">
</td></tr><tr id="line-67"><td class="table-line l-table"><a href="#line-67">67</a></td><td class="code-line l-code">
</td></tr><tr id="line-68"><td class="table-line d-table"><a href="#line-68">68</a></td><td class="code-line d-code"><span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
</td></tr><tr id="line-69"><td class="table-line l-table"><a href="#line-69">69</a></td><td class="code-line l-code">	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
</td></tr><tr id="line-70"><td class="table-line d-table"><a href="#line-70"><strong>70</strong></a></td><td class="code-line d-code">		<span class="k">try</span><span class="p">:</span>
</td></tr><tr id="line-71"><td class="table-line l-table"><a href="#line-71">71</a></td><td class="code-line l-code">			<span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</td></tr><tr id="line-72"><td class="table-line d-table"><a href="#line-72">72</a></td><td class="code-line d-code">				<span class="n">TG_API_ID</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TG_API_ID&#39;</span><span class="p">],</span>
</td></tr><tr id="line-73"><td class="table-line l-table"><a href="#line-73">73</a></td><td class="code-line l-code">				<span class="n">TG_API_HASH</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TG_API_HASH&#39;</span><span class="p">],</span>
</td></tr><tr id="line-74"><td class="table-line d-table"><a href="#line-74">74</a></td><td class="code-line d-code">				<span class="n">DB_USER_1</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DB_USER_1&#39;</span><span class="p">],</span>
</td></tr><tr id="line-75"><td class="table-line l-table"><a href="#line-75">75</a></td><td class="code-line l-code">				<span class="n">DB_USER_2</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DB_USER_2&#39;</span><span class="p">],</span>
</td></tr><tr id="line-76"><td class="table-line d-table"><a href="#line-76">76</a></td><td class="code-line d-code">				<span class="n">DB_PASS_1</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DB_PASS_1&#39;</span><span class="p">],</span>
</td></tr><tr id="line-77"><td class="table-line l-table"><a href="#line-77">77</a></td><td class="code-line l-code">				<span class="n">DB_PASS_2</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DB_PASS_2&#39;</span><span class="p">],</span>
</td></tr><tr id="line-78"><td class="table-line d-table"><a href="#line-78">78</a></td><td class="code-line d-code">				<span class="n">DB_NAME_1</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DB_NAME_1&#39;</span><span class="p">],</span>
</td></tr><tr id="line-79"><td class="table-line l-table"><a href="#line-79">79</a></td><td class="code-line l-code">				<span class="n">DB_NAME_2</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DB_NAME_2&#39;</span><span class="p">],</span>
</td></tr><tr id="line-80"><td class="table-line d-table"><a href="#line-80"><strong>80</strong></a></td><td class="code-line d-code">				<span class="n">DB_HOST_1</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DB_HOST_1&#39;</span><span class="p">],</span>
</td></tr><tr id="line-81"><td class="table-line l-table"><a href="#line-81">81</a></td><td class="code-line l-code">				<span class="n">DB_HOST_2</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DB_HOST_2&#39;</span><span class="p">],</span>
</td></tr><tr id="line-82"><td class="table-line d-table"><a href="#line-82">82</a></td><td class="code-line d-code">				<span class="n">MF_CHAT_ID</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MF_CHAT_ID&#39;</span><span class="p">]</span>
</td></tr><tr id="line-83"><td class="table-line l-table"><a href="#line-83">83</a></td><td class="code-line l-code">			<span class="p">)</span>
</td></tr><tr id="line-84"><td class="table-line d-table"><a href="#line-84">84</a></td><td class="code-line d-code">		<span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
</td></tr><tr id="line-85"><td class="table-line l-table"><a href="#line-85">85</a></td><td class="code-line l-code">			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</td></tr><tr id="line-86"><td class="table-line d-table"><a href="#line-86">86</a></td><td class="code-line d-code">				<span class="nb">str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</td></tr><tr id="line-87"><td class="table-line l-table"><a href="#line-87">87</a></td><td class="code-line l-code">					<span class="s1">&#39;Cannot get </span><span class="si">{}</span><span class="s1"> environment variable.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
</td></tr><tr id="line-88"><td class="table-line d-table"><a href="#line-88">88</a></td><td class="code-line d-code">					<span class="s1">&#39;Usage:</span><span class="se">\n</span><span class="s1">&#39;</span>
</td></tr><tr id="line-89"><td class="table-line l-table"><a href="#line-89">89</a></td><td class="code-line l-code">					<span class="s1">&#39;</span><span class="se">\t</span><span class="s1">TG_API_ID=&lt;id&gt; TG_API_HASH=&lt;hash&gt; MF_CHAT_ID=&lt;id&gt; </span><span class="se">\\\n</span><span class="s1">&#39;</span>
</td></tr><tr id="line-90"><td class="table-line d-table"><a href="#line-90"><strong>90</strong></a></td><td class="code-line d-code">					<span class="s1">&#39;</span><span class="se">\t</span><span class="s1">DB_USER_1=&lt;user&gt; DB_PASS_1=&lt;password&gt; DB_NAME_1=&lt;database&gt; DB_HOST_1=&lt;host&gt; </span><span class="se">\\\n</span><span class="s1">&#39;</span>
</td></tr><tr id="line-91"><td class="table-line l-table"><a href="#line-91">91</a></td><td class="code-line l-code">					<span class="s1">&#39;</span><span class="se">\t</span><span class="s1">DB_USER_2=&lt;user&gt; DB_PASS_2=&lt;password&gt; DB_NAME_2=&lt;database&gt; DB_HOST_2=&lt;host&gt; </span><span class="se">\\\n</span><span class="s1">&#39;</span>
</td></tr><tr id="line-92"><td class="table-line d-table"><a href="#line-92">92</a></td><td class="code-line d-code">					<span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="vm">__file__</span>
</td></tr><tr id="line-93"><td class="table-line l-table"><a href="#line-93">93</a></td><td class="code-line l-code">				<span class="p">)</span>
</td></tr><tr id="line-94"><td class="table-line d-table"><a href="#line-94">94</a></td><td class="code-line d-code">			<span class="p">)</span>
</td></tr><tr id="line-95"><td class="table-line l-table"><a href="#line-95">95</a></td><td class="code-line l-code">
</td></tr><tr id="line-96"><td class="table-line d-table"><a href="#line-96">96</a></td><td class="code-line d-code">
</td></tr><tr id="line-97"><td class="table-line l-table"><a href="#line-97">97</a></td><td class="code-line l-code"><span class="k">class</span> <span class="nc">Telegram</span><span class="p">:</span>
</td></tr><tr id="line-98"><td class="table-line d-table"><a href="#line-98">98</a></td><td class="code-line d-code">	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
</td></tr><tr id="line-99"><td class="table-line l-table"><a href="#line-99">99</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">telethon</span><span class="o">.</span><span class="n">TelegramClient</span><span class="p">(</span><span class="s1">&#39;get_ids&#39;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;TG_API_ID&#39;</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;TG_API_HASH&#39;</span><span class="p">])</span>
</td></tr><tr id="line-100"><td class="table-line d-table"><a href="#line-100"><strong>100</strong></a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</td></tr><tr id="line-101"><td class="table-line l-table"><a href="#line-101">101</a></td><td class="code-line l-code">
</td></tr><tr id="line-102"><td class="table-line d-table"><a href="#line-102">102</a></td><td class="code-line d-code">
</td></tr><tr id="line-103"><td class="table-line l-table"><a href="#line-103">103</a></td><td class="code-line l-code"><span class="k">class</span> <span class="nc">Importer</span><span class="p">:</span>
</td></tr><tr id="line-104"><td class="table-line d-table"><a href="#line-104">104</a></td><td class="code-line d-code">	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">tg</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
</td></tr><tr id="line-105"><td class="table-line l-table"><a href="#line-105">105</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">tg</span> <span class="o">=</span> <span class="n">tg</span>
</td></tr><tr id="line-106"><td class="table-line d-table"><a href="#line-106">106</a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
</td></tr><tr id="line-107"><td class="table-line l-table"><a href="#line-107">107</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
</td></tr><tr id="line-108"><td class="table-line d-table"><a href="#line-108">108</a></td><td class="code-line d-code">
</td></tr><tr id="line-109"><td class="table-line l-table"><a href="#line-109">109</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">conn_db_1</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
</td></tr><tr id="line-110"><td class="table-line d-table"><a href="#line-110"><strong>110</strong></a></td><td class="code-line d-code">			<span class="n">user</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;DB_USER_1&#39;</span><span class="p">],</span> <span class="n">password</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;DB_PASS_1&#39;</span><span class="p">],</span> <span class="n">database</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;DB_NAME_1&#39;</span><span class="p">],</span> <span class="n">host</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;DB_HOST_1&#39;</span><span class="p">]</span>
</td></tr><tr id="line-111"><td class="table-line l-table"><a href="#line-111">111</a></td><td class="code-line l-code">		<span class="p">)</span>
</td></tr><tr id="line-112"><td class="table-line d-table"><a href="#line-112">112</a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">conn_db_2</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
</td></tr><tr id="line-113"><td class="table-line l-table"><a href="#line-113">113</a></td><td class="code-line l-code">			<span class="n">user</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;DB_USER_2&#39;</span><span class="p">],</span> <span class="n">password</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;DB_PASS_2&#39;</span><span class="p">],</span> <span class="n">database</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;DB_NAME_2&#39;</span><span class="p">],</span> <span class="n">host</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;DB_HOST_2&#39;</span><span class="p">]</span>
</td></tr><tr id="line-114"><td class="table-line d-table"><a href="#line-114">114</a></td><td class="code-line d-code">		<span class="p">)</span>
</td></tr><tr id="line-115"><td class="table-line l-table"><a href="#line-115">115</a></td><td class="code-line l-code">		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_db_1</span><span class="p">:</span>
</td></tr><tr id="line-116"><td class="table-line d-table"><a href="#line-116">116</a></td><td class="code-line d-code">			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Cannot connect to the </span><span class="si">{}</span><span class="s1"> database.&#39;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;DB_NAME_1&#39;</span><span class="p">]))</span>
</td></tr><tr id="line-117"><td class="table-line l-table"><a href="#line-117">117</a></td><td class="code-line l-code">		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_db_2</span><span class="p">:</span>
</td></tr><tr id="line-118"><td class="table-line d-table"><a href="#line-118">118</a></td><td class="code-line d-code">			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Cannot connect to the </span><span class="si">{}</span><span class="s1"> database.&#39;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;DB_NAME_2&#39;</span><span class="p">]))</span>
</td></tr><tr id="line-119"><td class="table-line l-table"><a href="#line-119">119</a></td><td class="code-line l-code">
</td></tr><tr id="line-120"><td class="table-line d-table"><a href="#line-120"><strong>120</strong></a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_db_1</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</td></tr><tr id="line-121"><td class="table-line l-table"><a href="#line-121">121</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_db_2</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</td></tr><tr id="line-122"><td class="table-line d-table"><a href="#line-122">122</a></td><td class="code-line d-code">
</td></tr><tr id="line-123"><td class="table-line l-table"><a href="#line-123">123</a></td><td class="code-line l-code">	<span class="nb">staticmethod</span>
</td></tr><tr id="line-124"><td class="table-line d-table"><a href="#line-124">124</a></td><td class="code-line d-code">	<span class="k">def</span> <span class="nf">filter_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
</td></tr><tr id="line-125"><td class="table-line l-table"><a href="#line-125">125</a></td><td class="code-line l-code">		<span class="n">patch</span> <span class="o">=</span> <span class="p">{</span>
</td></tr><tr id="line-126"><td class="table-line d-table"><a href="#line-126">126</a></td><td class="code-line d-code">			<span class="s1">&#39;a1batross_2&#39;</span><span class="p">:</span> <span class="s1">&#39;a1batross&#39;</span><span class="p">,</span>
</td></tr><tr id="line-127"><td class="table-line l-table"><a href="#line-127">127</a></td><td class="code-line l-code">			<span class="s1">&#39;mrPazzi&#39;</span><span class="p">:</span> <span class="s1">&#39;drPazzi&#39;</span><span class="p">,</span>
</td></tr><tr id="line-128"><td class="table-line d-table"><a href="#line-128">128</a></td><td class="code-line d-code">			<span class="s1">&#39;ilikeeatingkids&#39;</span><span class="p">:</span> <span class="s1">&#39;Ilovetoeatchildren&#39;</span><span class="p">,</span>
</td></tr><tr id="line-129"><td class="table-line l-table"><a href="#line-129">129</a></td><td class="code-line l-code">			<span class="s1">&#39;Igorek_Dim&#39;</span><span class="p">:</span> <span class="s1">&#39;iProcyon&#39;</span><span class="p">,</span>
</td></tr><tr id="line-130"><td class="table-line d-table"><a href="#line-130"><strong>130</strong></a></td><td class="code-line d-code">			<span class="s1">&#39;ConsleslingDown&#39;</span><span class="p">:</span> <span class="s1">&#39;Conslesling&#39;</span>
</td></tr><tr id="line-131"><td class="table-line l-table"><a href="#line-131">131</a></td><td class="code-line l-code">		<span class="p">}</span>
</td></tr><tr id="line-132"><td class="table-line d-table"><a href="#line-132">132</a></td><td class="code-line d-code">		<span class="k">return</span> <span class="n">patch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</td></tr><tr id="line-133"><td class="table-line l-table"><a href="#line-133">133</a></td><td class="code-line l-code">
</td></tr><tr id="line-134"><td class="table-line d-table"><a href="#line-134">134</a></td><td class="code-line d-code">	<span class="k">def</span> <span class="nf">import_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</td></tr><tr id="line-135"><td class="table-line l-table"><a href="#line-135">135</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;=&gt; Start commit digest users.&#39;</span><span class="p">)</span>
</td></tr><tr id="line-136"><td class="table-line d-table"><a href="#line-136">136</a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;TRUNCATE TABLE bot_digest_user CASCADE&#39;</span><span class="p">)</span>
</td></tr><tr id="line-137"><td class="table-line l-table"><a href="#line-137">137</a></td><td class="code-line l-code">
</td></tr><tr id="line-138"><td class="table-line d-table"><a href="#line-138">138</a></td><td class="code-line d-code">		<span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
</td></tr><tr id="line-139"><td class="table-line l-table"><a href="#line-139">139</a></td><td class="code-line l-code">		<span class="n">user_without_id</span> <span class="o">=</span> <span class="mi">0</span>
</td></tr><tr id="line-140"><td class="table-line d-table"><a href="#line-140"><strong>140</strong></a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_1</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM digests_users&#39;</span><span class="p">)</span>
</td></tr><tr id="line-141"><td class="table-line l-table"><a href="#line-141">141</a></td><td class="code-line l-code">		<span class="k">for</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">avatar</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_db_1</span><span class="p">:</span>
</td></tr><tr id="line-142"><td class="table-line d-table"><a href="#line-142">142</a></td><td class="code-line d-code">			<span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</td></tr><tr id="line-143"><td class="table-line l-table"><a href="#line-143">143</a></td><td class="code-line l-code">			<span class="k">try</span><span class="p">:</span>
</td></tr><tr id="line-144"><td class="table-line d-table"><a href="#line-144">144</a></td><td class="code-line d-code">				<span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tg</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
</td></tr><tr id="line-145"><td class="table-line l-table"><a href="#line-145">145</a></td><td class="code-line l-code">			<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</td></tr><tr id="line-146"><td class="table-line d-table"><a href="#line-146">146</a></td><td class="code-line d-code">				<span class="n">user_id</span> <span class="o">=</span> <span class="n">user_without_id</span> <span class="o">+</span> <span class="mi">1</span>
</td></tr><tr id="line-147"><td class="table-line l-table"><a href="#line-147">147</a></td><td class="code-line l-code">				<span class="n">user_without_id</span> <span class="o">+=</span> <span class="mi">1</span>
</td></tr><tr id="line-148"><td class="table-line d-table"><a href="#line-148">148</a></td><td class="code-line d-code">			<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Without delay, you can run into a ban.</span>
</td></tr><tr id="line-149"><td class="table-line l-table"><a href="#line-149">149</a></td><td class="code-line l-code">
</td></tr><tr id="line-150"><td class="table-line d-table"><a href="#line-150"><strong>150</strong></a></td><td class="code-line d-code">			<span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
</td></tr><tr id="line-151"><td class="table-line l-table"><a href="#line-151">151</a></td><td class="code-line l-code">				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Commit user </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
</td></tr><tr id="line-152"><td class="table-line d-table"><a href="#line-152">152</a></td><td class="code-line d-code">				<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</td></tr><tr id="line-153"><td class="table-line l-table"><a href="#line-153">153</a></td><td class="code-line l-code">					<span class="s1">&#39;INSERT INTO bot_digest_user (id, avatar, username) VALUES (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
</td></tr><tr id="line-154"><td class="table-line d-table"><a href="#line-154">154</a></td><td class="code-line d-code">					<span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">avatar</span><span class="p">,</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">filtered</span><span class="p">)</span>
</td></tr><tr id="line-155"><td class="table-line l-table"><a href="#line-155">155</a></td><td class="code-line l-code">				<span class="p">)</span>
</td></tr><tr id="line-156"><td class="table-line d-table"><a href="#line-156">156</a></td><td class="code-line d-code">				<span class="bp">self</span><span class="o">.</span><span class="n">conn_db_2</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</td></tr><tr id="line-157"><td class="table-line l-table"><a href="#line-157">157</a></td><td class="code-line l-code">				<span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</td></tr><tr id="line-158"><td class="table-line d-table"><a href="#line-158">158</a></td><td class="code-line d-code">			<span class="k">else</span><span class="p">:</span>
</td></tr><tr id="line-159"><td class="table-line l-table"><a href="#line-159">159</a></td><td class="code-line l-code">				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Ignoring user </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> (already in database).&#39;</span><span class="p">,</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
</td></tr><tr id="line-160"><td class="table-line d-table"><a href="#line-160"><strong>160</strong></a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;=&gt; End commit digest users.&#39;</span><span class="p">)</span>
</td></tr><tr id="line-161"><td class="table-line l-table"><a href="#line-161">161</a></td><td class="code-line l-code">
</td></tr><tr id="line-162"><td class="table-line d-table"><a href="#line-162">162</a></td><td class="code-line d-code">	<span class="k">def</span> <span class="nf">import_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</td></tr><tr id="line-163"><td class="table-line l-table"><a href="#line-163">163</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;=&gt; Start commit digests&#39;</span><span class="p">)</span>
</td></tr><tr id="line-164"><td class="table-line d-table"><a href="#line-164">164</a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;TRUNCATE TABLE bot_digest&#39;</span><span class="p">)</span>
</td></tr><tr id="line-165"><td class="table-line l-table"><a href="#line-165">165</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">conn_db_2</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</td></tr><tr id="line-166"><td class="table-line d-table"><a href="#line-166">166</a></td><td class="code-line d-code">
</td></tr><tr id="line-167"><td class="table-line l-table"><a href="#line-167">167</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_1</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM digests&#39;</span><span class="p">)</span>
</td></tr><tr id="line-168"><td class="table-line d-table"><a href="#line-168">168</a></td><td class="code-line d-code">		<span class="n">digest_id</span> <span class="o">=</span> <span class="mi">1</span>
</td></tr><tr id="line-169"><td class="table-line l-table"><a href="#line-169">169</a></td><td class="code-line l-code">		<span class="k">for</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_db_1</span><span class="p">:</span>
</td></tr><tr id="line-170"><td class="table-line d-table"><a href="#line-170"><strong>170</strong></a></td><td class="code-line d-code">			<span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</td></tr><tr id="line-171"><td class="table-line l-table"><a href="#line-171">171</a></td><td class="code-line l-code">			<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id FROM bot_digest_user WHERE username LIKE </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">filtered</span><span class="p">,))</span>
</td></tr><tr id="line-172"><td class="table-line d-table"><a href="#line-172">172</a></td><td class="code-line d-code">			<span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_db_2</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</td></tr><tr id="line-173"><td class="table-line l-table"><a href="#line-173">173</a></td><td class="code-line l-code">			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Commit digest </span><span class="si">{}</span><span class="s1"> from </span><span class="si">{}</span><span class="s1"> at timestamp </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">digest_id</span><span class="p">,</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
</td></tr><tr id="line-174"><td class="table-line d-table"><a href="#line-174">174</a></td><td class="code-line d-code">			<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</td></tr><tr id="line-175"><td class="table-line l-table"><a href="#line-175">175</a></td><td class="code-line l-code">				<span class="s1">&#39;INSERT INTO bot_digest (id, chat, date, message_id, digest, user_id) VALUES (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
</td></tr><tr id="line-176"><td class="table-line d-table"><a href="#line-176">176</a></td><td class="code-line d-code">				<span class="p">(</span><span class="n">digest_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;MF_CHAT_ID&#39;</span><span class="p">],</span> <span class="n">date</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</td></tr><tr id="line-177"><td class="table-line l-table"><a href="#line-177">177</a></td><td class="code-line l-code">			<span class="p">)</span>
</td></tr><tr id="line-178"><td class="table-line d-table"><a href="#line-178">178</a></td><td class="code-line d-code">			<span class="bp">self</span><span class="o">.</span><span class="n">conn_db_2</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</td></tr><tr id="line-179"><td class="table-line l-table"><a href="#line-179">179</a></td><td class="code-line l-code">			<span class="n">digest_id</span> <span class="o">+=</span> <span class="mi">1</span>
</td></tr><tr id="line-180"><td class="table-line d-table"><a href="#line-180"><strong>180</strong></a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;=&gt; End commit digests&#39;</span><span class="p">)</span>
</td></tr><tr id="line-181"><td class="table-line l-table"><a href="#line-181">181</a></td><td class="code-line l-code">
</td></tr><tr id="line-182"><td class="table-line d-table"><a href="#line-182">182</a></td><td class="code-line d-code">	<span class="c1"># In a Spring Boot project, you must use &quot;GenerationType.IDENTITY&quot; for &quot;@Id&quot; column.</span>
</td></tr><tr id="line-183"><td class="table-line l-table"><a href="#line-183">183</a></td><td class="code-line l-code">	<span class="c1"># Due to this, a table &quot;bot_digest_id_seq&quot; will appear.</span>
</td></tr><tr id="line-184"><td class="table-line d-table"><a href="#line-184">184</a></td><td class="code-line d-code">	<span class="c1"># Additional information: https://hcmc.uvic.ca/blogs/index.php/how_to_fix_postgresql_error_duplicate_ke?blog=22</span>
</td></tr><tr id="line-185"><td class="table-line l-table"><a href="#line-185">185</a></td><td class="code-line l-code">	<span class="k">def</span> <span class="nf">fix_autogenerated_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</td></tr><tr id="line-186"><td class="table-line d-table"><a href="#line-186">186</a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;=&gt; Start fix autogenerated ids.&#39;</span><span class="p">)</span>
</td></tr><tr id="line-187"><td class="table-line l-table"><a href="#line-187">187</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</td></tr><tr id="line-188"><td class="table-line d-table"><a href="#line-188">188</a></td><td class="code-line d-code">			<span class="s2">&quot;SELECT setval(&#39;bot_digest_id_seq&#39;, (SELECT MAX(id) FROM bot_digest) + 1)&quot;</span>
</td></tr><tr id="line-189"><td class="table-line l-table"><a href="#line-189">189</a></td><td class="code-line l-code">		<span class="p">)</span>
</td></tr><tr id="line-190"><td class="table-line d-table"><a href="#line-190"><strong>190</strong></a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;=&gt; End fix autogenerated ids.&#39;</span><span class="p">)</span>
</td></tr><tr id="line-191"><td class="table-line l-table"><a href="#line-191">191</a></td><td class="code-line l-code">
</td></tr><tr id="line-192"><td class="table-line d-table"><a href="#line-192">192</a></td><td class="code-line d-code">	<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</td></tr><tr id="line-193"><td class="table-line l-table"><a href="#line-193">193</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</td></tr><tr id="line-194"><td class="table-line d-table"><a href="#line-194">194</a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">curr_db_1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</td></tr><tr id="line-195"><td class="table-line l-table"><a href="#line-195">195</a></td><td class="code-line l-code">		<span class="bp">self</span><span class="o">.</span><span class="n">conn_db_2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</td></tr><tr id="line-196"><td class="table-line d-table"><a href="#line-196">196</a></td><td class="code-line d-code">		<span class="bp">self</span><span class="o">.</span><span class="n">conn_db_1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</td></tr><tr id="line-197"><td class="table-line l-table"><a href="#line-197">197</a></td><td class="code-line l-code">
</td></tr><tr id="line-198"><td class="table-line d-table"><a href="#line-198">198</a></td><td class="code-line d-code">
</td></tr><tr id="line-199"><td class="table-line l-table"><a href="#line-199">199</a></td><td class="code-line l-code"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</td></tr><tr id="line-200"><td class="table-line d-table"><a href="#line-200"><strong>200</strong></a></td><td class="code-line d-code">	<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>
</td></tr><tr id="line-201"><td class="table-line l-table"><a href="#line-201">201</a></td><td class="code-line l-code">	<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">cfg</span>
</td></tr><tr id="line-202"><td class="table-line d-table"><a href="#line-202">202</a></td><td class="code-line d-code">	<span class="n">client</span> <span class="o">=</span> <span class="n">Telegram</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">client</span>
</td></tr><tr id="line-203"><td class="table-line l-table"><a href="#line-203">203</a></td><td class="code-line l-code">	<span class="n">importer</span> <span class="o">=</span> <span class="n">Importer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</td></tr><tr id="line-204"><td class="table-line d-table"><a href="#line-204">204</a></td><td class="code-line d-code">	<span class="n">importer</span><span class="o">.</span><span class="n">import_users</span><span class="p">()</span>
</td></tr><tr id="line-205"><td class="table-line l-table"><a href="#line-205">205</a></td><td class="code-line l-code">	<span class="n">importer</span><span class="o">.</span><span class="n">import_digest</span><span class="p">()</span>
</td></tr><tr id="line-206"><td class="table-line d-table"><a href="#line-206">206</a></td><td class="code-line d-code">	<span class="n">importer</span><span class="o">.</span><span class="n">fix_autogenerated_id</span><span class="p">()</span>
</td></tr><tr id="line-207"><td class="table-line l-table"><a href="#line-207">207</a></td><td class="code-line l-code">	<span class="n">importer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</td></tr><tr id="line-208"><td class="table-line d-table"><a href="#line-208">208</a></td><td class="code-line d-code">	<span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</td></tr></table>